<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Недели 2025 года и фазы луны</title>
    <style>
        body {
            font-family: "Courier New", Courier, monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        
        /* Добавляем стили для фиксированного заголовка */
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        thead th {
            background-color: #f2f2f2;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        }
        
        .week-number {
            font-weight: bold;
        }
        .predominant-phase {
            font-weight: bold;
        }
        .date {
            font-size: 0.9em;
        }
        .moon-phase {
            font-size: 1.2em;
        }
        
        table td {
            vertical-align: top;
        }
        
        /* Добавляем стили для цветовой группировки недель */
        tr.quarter-1 {
            background-color: rgba(67, 103, 134, 0.5); /* Светло-голубой */
        }
        
        tr.quarter-2 {
            background-color: rgba(53, 156, 53, 0.5); /* Светло-зеленый */
        }
        
        tr.quarter-3 {
            background-color: rgba(161, 104, 38, 0.5); /* Светло-оранжевый */
        }
        
        tr.quarter-4 {
            background-color: rgba(172, 26, 74, 0.5); /* Светло-розовый */
        }
        
        /* Добавляем чередование строк через одну */
        #calendar-body tr:nth-child(even) {
            background-image: linear-gradient(rgba(211, 211, 211, 0.3), rgba(211, 211, 211, 0.3));
        }
        
        /* Убеждаемся, что стили чередования работают корректно с цветами кварталов */
        #calendar-body tr:nth-child(even).quarter-1 {
            background-image: linear-gradient(rgba(67, 103, 134, 0.5), rgba(67, 103, 134, 0.5)), linear-gradient(rgba(211, 211, 211, 0.3), rgba(211, 211, 211, 0.3));
        }
        
        #calendar-body tr:nth-child(even).quarter-2 {
            background-image: linear-gradient(rgba(53, 156, 53, 0.5), rgba(53, 156, 53, 0.5)), linear-gradient(rgba(211, 211, 211, 0.3), rgba(211, 211, 211, 0.3));
        }
        
        #calendar-body tr:nth-child(even).quarter-3 {
            background-image: linear-gradient(rgba(161, 104, 38, 0.5), rgba(161, 104, 38, 0.5)), linear-gradient(rgba(211, 211, 211, 0.3), rgba(211, 211, 211, 0.3));
        }
        
        #calendar-body tr:nth-child(even).quarter-4 {
            background-image: linear-gradient(rgba(172, 26, 74, 0.5), rgba(172, 26, 74, 0.5)), linear-gradient(rgba(211, 211, 211, 0.3), rgba(211, 211, 211, 0.3));
        }
        
        /* Добавляем стиль для недель с преобладающей убывающей луной */
        tr.waning-moon {
            color: #2b5797;
            font-weight: 500;
        }
        
        /* Добавляем стиль для недель с последней четвертью луны */
        tr.last-quarter-moon {
            color: #8a2be2; /* Фиолетовый цвет для выделения */
            font-weight: 600;
        }
        
        /* Стили для выделения текущей недели и текущего дня */
        tr.current-week {
            outline: 3px solid #ff5722;
            position: relative;
            z-index: 5;
        }
        
        td.current-day {
            background-color: rgba(255, 87, 34, 0.3);
            position: relative;
            font-weight: bold;
        }
        
        td.current-day::after {
            content: '✓';
            position: absolute;
            top: 0;
            right: 2px;
            font-size: 10px;
            color: #ff5722;
        }
        
        /* Стили для модального окна и столбца Описание */
        .description-cell {
            cursor: pointer;
            position: relative;
            text-align: center;
            color: #555;
            font-weight: bold;
        }
        
        .description-cell:hover {
            color: #000;
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 20;
            width: 300px;
            right: 0;
            top: 100%;
            text-align: left;
            font-weight: normal;
            color: #333;
        }
        
        .description-cell:hover .modal {
            display: block;
        }
        
        /* Стили для столбца с расширенными рекомендациями */
        .extended-recommendations {
            cursor: pointer;
            position: relative;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            color: #444;
        }
        
        .extended-recommendations:hover {
            color: #000;
        }
        
        .extended-modal {
            display: none;
            position: fixed;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            width: 500px;
            max-width: 80%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: left;
            font-weight: normal;
            color: #333;
            line-height: 1.4;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Затемнение фона при открытии модального окна */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }
        
        /* Изменяем способ отображения модального окна */
        .extended-recommendations:hover .extended-modal,
        .extended-recommendations:hover + .modal-backdrop {
            display: block;
        }
        
        .planet-influence {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dotted #ccc;
        }
        /* Добавляем стили для кастомного date picker */
        .custom-datepicker {
            position: relative;
            display: inline-block;
        }
        
        .datepicker-toggle {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        
        .datepicker-input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: "Courier New", Courier, monospace;
            width: 150px;
        }
        
        .datepicker-calendar {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 280px;
            padding: 10px;
            margin-top: 2px;
        }
        
        .datepicker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .month-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .month-display {
            font-weight: bold;
            text-align: center;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .calendar-day:hover {
            background-color: #f0f0f0;
        }
        
        .calendar-day.today {
            background-color: #e6f7ff;
            font-weight: bold;
        }
        
        .calendar-day.selected {
            background-color: #4CAF50;
            color: white;
        }
        
        .calendar-day.other-month {
            color: #ccc;
        }
        
        .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Недели 2025 года и фазы луны</h1>
    
    <!-- Заменяем стандартный date picker на кастомный -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f8f8; border-radius: 5px; border: 1px solid #ddd;">
        <label for="start-date">Стартовая дата для расчета недель: </label>
        <div class="custom-datepicker">
            <div class="datepicker-toggle">
                <input type="text" id="datepicker-input" class="datepicker-input" readonly value="01.01.2025">
                <input type="hidden" id="start-date" value="2025-01-01">
            </div>
            <div id="datepicker-calendar" class="datepicker-calendar">
                <button class="close-btn">&times;</button>
                <div class="datepicker-header">
                    <button class="month-nav prev-month">&lt;</button>
                    <div class="month-display">Январь 2025</div>
                    <button class="month-nav next-month">&gt;</button>
                </div>
                <div class="weekdays">
                    <div>Пн</div>
                    <div>Вт</div>
                    <div>Ср</div>
                    <div>Чт</div>
                    <div>Пт</div>
                    <div>Сб</div>
                    <div>Вс</div>
                </div>
                <div class="calendar-days"></div>
            </div>
        </div>
        <button id="recalculate-btn" style="margin-left: 10px; padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">Пересчитать</button>
    </div>
    
    <table id="lunar-calendar">
        <thead>
            <tr>
                <th>№ Нед</th>
                <th>№ Пер</th>
                <th>№ Лун Цик</th>
                <th>Месяц</th>
                <th>Даты</th>
                <th>Преобладающая фаза</th>
                <th>События</th>
                <th>ПН</th>
                <th>ВТ</th>
                <th>СР</th>
                <th>ЧТ</th>
                <th>ПТ</th>
                <th>СБ</th>
                <th>ВС</th>
                <th>Описание</th>
                <th>+</th>
            </tr>
        </thead>
        <tbody id="calendar-body">
            <!-- Данные будут заполнены с помощью JavaScript -->
        </tbody>
    </table>

    <script>
        // Функция для расчета фазы луны
        function getMoonPhase(date) {
            const LUNAR_MONTH = 29.53058867; // Лунный месяц в днях
            
            // Новолуние 6 января 2000 года - опорная точка
            const reference = new Date(2000, 0, 6, 18, 14, 0);
            
            // Разница в миллисекундах
            const diff = date.getTime() - reference.getTime();
            const days = diff / (1000 * 60 * 60 * 24);
            const cycles = days / LUNAR_MONTH;
            
            // Получаем только дробную часть
            let phase = cycles - Math.floor(cycles);
            
            // Преобразуем в угол (0 - 1 → 0° - 360°)
            phase = phase * 360;
            
            // Определяем фазу луны по углу
            if (phase < 22.5) return { symbol: "🌑", name: "Новолуние" };
            else if (phase < 67.5) return { symbol: "🌒", name: "Растущий полумесяц" };
            else if (phase < 112.5) return { symbol: "🌓", name: "Первая четверть" };
            else if (phase < 157.5) return { symbol: "🌔", name: "Растущая луна" };
            else if (phase < 202.5) return { symbol: "🌕", name: "Полнолуние" };
            else if (phase < 247.5) return { symbol: "🌖", name: "Убывающая луна" };
            else if (phase < 292.5) return { symbol: "🌗", name: "Последняя четверть" };
            else if (phase < 337.5) return { symbol: "🌘", name: "Убывающий полумесяц" };
            else return { symbol: "🌑", name: "Новолуние" };
        }

        // Функция для определения преобладающей фазы луны на неделе
        function getPredominantMoonPhase(phases) {
            const phaseCounts = {};
            
            // Подсчитываем количество каждой фазы
            phases.forEach(phase => {
                if (!phaseCounts[phase.name]) {
                    phaseCounts[phase.name] = { count: 0, symbol: phase.symbol };
                }
                phaseCounts[phase.name].count++;
            });
            
            // Находим фазу с наибольшим количеством
            let predominant = { name: "", count: 0, symbol: "" };
            for (const [name, data] of Object.entries(phaseCounts)) {
                if (data.count > predominant.count) {
                    predominant = { name, count: data.count, symbol: data.symbol };
                }
            }
            
            return predominant;
        }

        // Функция для получения номера недели по ISO
        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Функция для форматирования даты
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric' });
        }

        // Получаем текущую дату
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        const currentDay = currentDate.getDate();
        
        // Определяем стартовую дату для расчетов
        let startDate = new Date(2025, 0, 1); // По умолчанию 1 января 2025
        let firstNewMoonReference; // Переменная для хранения первого новолуния выбранного года
        
        // Функция для создания календаря
        function createCalendar(startingDate) {
            // Очищаем существующие данные
            const tableBody = document.getElementById('calendar-body');
            tableBody.innerHTML = '';
            
            // Сбрасываем модальные окна
            document.querySelectorAll('.extended-modal, .modal-backdrop').forEach(el => {
                el.remove();
            });
            
            // Поиск первого понедельника не ранее стартовой даты
            let currentMonday = new Date(startingDate);
            // Если текущий день не понедельник (1), двигаемся назад до ближайшего понедельника
            while (currentMonday.getDay() !== 1) {
                currentMonday.setDate(currentMonday.getDate() - 1);
            }
            
            // Определяем конечную дату - ровно год от начальной даты
            const endDate = new Date(startingDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            endDate.setDate(endDate.getDate() - 1); // Вычитаем 1 день для получения полного года
            
            let weekNumber = 1;
            
            // Хранение истории фаз для соседних недель
            let previousWeekPhases = [];
            let currentWeekPhases = [];
            let nextWeekPhases = [];
            
            // Временный массив для формирования следующей недели
            const tempNextWeekPhases = [];
            
            while (currentMonday <= endDate) {
                // Массивы для хранения дней недели и фаз луны
                const weekDays = [];
                const moonPhases = [];
                
                // Собираем дни недели и фазы луны
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(currentMonday);
                    currentDay.setDate(currentMonday.getDate() + i);
                    weekDays.push(currentDay);
                    
                    // Рассчитываем фазу луны для каждого дня
                    const moonPhase = getMoonPhase(currentDay);
                    moonPhases.push(moonPhase);
                    
                    // Сохраняем фазу для текущей недели
                    nextWeekPhases.push(moonPhase);
                }
                
                // Создаем строку для недели
                const weekRow = document.createElement('tr');
                
                // Определяем класс квартала, исходя из номера недели
                const quarterClass = getQuarterClass(weekNumber);
                weekRow.className = quarterClass;
                
                // Создаем ячейку с номером недели
                const weekNumberCell = document.createElement('td');
                weekNumberCell.className = 'week-number';
                weekNumberCell.textContent = weekNumber;
                weekRow.appendChild(weekNumberCell);
                
                // Создаем ячейку с локальным номером недели (1-13)
                const localWeekCell = document.createElement('td');
                localWeekCell.className = 'local-week-number';
                const localWeekNumber = ((weekNumber - 1) % 13) + 1;
                localWeekCell.textContent = localWeekNumber;
                weekRow.appendChild(localWeekCell);
                
                // Создаем ячейку с номером лунного цикла
                const lunarCycleCell = document.createElement('td');
                lunarCycleCell.className = 'lunar-cycle';
                const lunarCycleNumber = getLunarCycleNumber(weekDays[3]); // Используем четверг как ориентир
                lunarCycleCell.textContent = lunarCycleNumber;
                weekRow.appendChild(lunarCycleCell);
                
                // Создаем ячейку с названием месяца (используем четверг (индекс 3) как определяющий день недели)
                const monthCell = document.createElement('td');
                const monthName = weekDays[3].toLocaleDateString('ru-RU', { month: 'long' });
                monthCell.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                weekRow.appendChild(monthCell);
                
                // Определяем преобладающую фазу луны
                const predominantPhase = getPredominantMoonPhase(moonPhases);
                
                // Проверяем условие для подсветки "Последней четверти"
                if (shouldHighlightLastQuarter(predominantPhase, moonPhases, previousWeekPhases, currentWeekPhases)) {
                    weekRow.classList.add("last-quarter-moon");
                }
                
                // Создаем ячейку с датами недели
                const weekDatesCell = document.createElement('td');
                weekDatesCell.className = 'date';
                weekDatesCell.textContent = `${formatDate(weekDays[0])} - ${formatDate(weekDays[6])}`;
                weekRow.appendChild(weekDatesCell);
                
                // Создаем ячейку с преобладающей фазой луны
                const predominantPhaseCell = document.createElement('td');
                predominantPhaseCell.className = 'predominant-phase';
                predominantPhaseCell.innerHTML = `${predominantPhase.symbol} ${predominantPhase.name}`;
                weekRow.appendChild(predominantPhaseCell);
                
                // Создаем ячейку с лунными событиями недели
                const eventsCell = document.createElement('td');
                const lunarEvents = detectLunarEvents(weekDays, moonPhases);
                if (lunarEvents.length > 0) {
                    eventsCell.innerHTML = lunarEvents.join('<br>');
                } else {
                    eventsCell.textContent = "-";
                }
                weekRow.appendChild(eventsCell);
                
                // Проверяем, является ли эта неделя текущей
                let isCurrentWeek = false;
                let currentDayIndex = -1;
                
                if (currentYear === 2025) {
                    // Проверяем, находится ли текущая дата в этой неделе
                    for (let i = 0; i < weekDays.length; i++) {
                        const day = weekDays[i];
                        if (day.getFullYear() === currentYear && 
                            day.getMonth() === currentMonth && 
                            day.getDate() === currentDay) {
                            isCurrentWeek = true;
                            currentDayIndex = i;
                            break;
                        }
                    }
                }
                
                // Если это текущая неделя, добавляем соответствующий класс
                if (isCurrentWeek) {
                    weekRow.classList.add('current-week');
                }
                
                // Создаем ячейки для каждого дня недели с фазой луны
                for (let i = 0; i < 7; i++) {
                    const dayCell = document.createElement('td');
                    dayCell.className = 'moon-phase';
                    
                    // Если это текущий день, добавляем соответствующий класс
                    if (isCurrentWeek && i === currentDayIndex) {
                        dayCell.classList.add('current-day');
                    }
                    
                    dayCell.title = moonPhases[i].name;
                    dayCell.textContent = moonPhases[i].symbol;
                    weekRow.appendChild(dayCell);
                }
                
                // Создаем ячейку с описанием и рекомендациями на основе фазы луны
                const descriptionCell = document.createElement('td');
                descriptionCell.className = 'description-cell';
                descriptionCell.textContent = 'Описание';
                
                // Создаем модальное окно с рекомендациями
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = getMoonPhaseDescription(predominantPhase.name);
                descriptionCell.appendChild(modal);
                
                weekRow.appendChild(descriptionCell);
                
                // Создаем ячейку с расширенными астрологическими рекомендациями
                const extendedCell = document.createElement('td');
                extendedCell.className = 'extended-recommendations';
                extendedCell.textContent = '+';
                
                // Создаем модальное окно с расширенными рекомендациями
                const extendedModal = document.createElement('div');
                extendedModal.className = 'extended-modal';
                
                // Получаем расширенные рекомендации, учитывая номер недели и фазу луны
                extendedModal.innerHTML = getExtendedRecommendations(weekNumber, predominantPhase.name, weekDays[3]);
                
                // Добавляем кнопку закрытия
                const closeButton = document.createElement('button');
                closeButton.textContent = '✕';
                closeButton.style.position = 'absolute';
                closeButton.style.right = '10px';
                closeButton.style.top = '10px';
                closeButton.style.background = 'none';
                closeButton.style.border = 'none';
                closeButton.style.fontSize = '16px';
                closeButton.style.cursor = 'pointer';
                closeButton.onclick = function(e) {
                    e.stopPropagation();
                    extendedModal.style.display = 'none';
                    document.querySelector('.modal-backdrop').style.display = 'none';
                };
                extendedModal.appendChild(closeButton);
                
                document.body.appendChild(extendedModal);
                
                // Создаем затемнение фона
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                document.body.appendChild(backdrop);
                
                // Обработчик клика на "+"
                extendedCell.onclick = function() {
                    extendedModal.style.display = 'block';
                    backdrop.style.display = 'block';
                };
                
                // Обработчик клика на фон для закрытия
                backdrop.onclick = function() {
                    extendedModal.style.display = 'none';
                    backdrop.style.display = 'none';
                };
                
                weekRow.appendChild(extendedCell);
                
                // Добавляем строку в таблицу
                tableBody.appendChild(weekRow);
                
                // Переходим к следующему понедельнику
                currentMonday.setDate(currentMonday.getDate() + 7);
                weekNumber++;
                
                // Обновляем историю фаз - сдвигаем недели
                previousWeekPhases = currentWeekPhases;
                currentWeekPhases = nextWeekPhases;
                nextWeekPhases = [];
            }
        }
        
        // Инициализация календаря с начальной датой
        createCalendar(startDate);
        
        // Обработчик события для кнопки пересчета
        document.getElementById('recalculate-btn').addEventListener('click', function() {
            const dateInput = document.getElementById('start-date');
            if (dateInput.value) {
                startDate = new Date(dateInput.value);
                
                // Обновляем референсную дату новолуния
                firstNewMoonReference = null; // Сбрасываем, чтобы пересчитать
                updateFirstNewMoonReference();
                
                // Формируем заголовок с диапазоном дат
                const startYear = startDate.getFullYear();
                const endDateCalc = new Date(startDate);
                endDateCalc.setFullYear(startYear + 1);
                endDateCalc.setDate(endDateCalc.getDate() - 1);
                const endYear = endDateCalc.getFullYear();
                
                if (startYear === endYear) {
                    document.querySelector('h1').textContent = `Календарь на ${startYear} год`;
                } else {
                    document.querySelector('h1').textContent = `Календарь на ${startYear}-${endYear} годы`;
                }
                
                // Пересоздаем календарь
                createCalendar(startDate);
            }
        });

        // Функция для определения ключевых лунных событий
        function detectLunarEvents(days, phases) {
            const events = [];
            const keyPhases = {
                "Новолуние": "🌑",
                "Полнолуние": "🌕",
                "Первая четверть": "🌓",
                "Последняя четверть": "🌗"
            };
            
            // Отслеживаем уже найденные фазы
            const foundPhases = {};
            
            // Проверяем каждый день на наличие ключевых фаз
            for (let i = 0; i < days.length; i++) {
                const phase = phases[i];
                if (Object.keys(keyPhases).includes(phase.name) && !foundPhases[phase.name]) {
                    const date = days[i];
                    const formattedDate = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric' });
                    events.push(`${formattedDate} - ${phase.symbol} ${phase.name}`);
                    // Отмечаем, что эта фаза уже найдена
                    foundPhases[phase.name] = true;
                }
            }
            
            return events;
        }

        // Функция для определения класса квартала по номеру недели
        function getQuarterClass(weekNumber) {
            if (weekNumber <= 13) {
                return "quarter-1";
            } else if (weekNumber <= 26) {
                return "quarter-2";
            } else if (weekNumber <= 39) {
                return "quarter-3";
            } else {
                return "quarter-4";
            }
        }

        // Функция для получения астрологических рекомендаций на основе фазы луны
        function getMoonPhaseDescription(phaseName) {
            const descriptions = {
                "Новолуние": "<strong>Новолуние</strong> - время начинаний. <br><br>Рекомендации астрологов:<br>• Начало новых проектов и планов<br>• Составление планов на будущее<br>• Медитация и самоанализ<br>• Отдых и восстановление энергии",
                
                "Растущий полумесяц": "<strong>Растущий полумесяц</strong> - время роста и развития. <br><br>Рекомендации астрологов:<br>• Активное развитие начатых дел<br>• Учеба и приобретение новых навыков<br>• Знакомства и общение<br>• Физическая активность",
                
                "Первая четверть": "<strong>Первая четверть</strong> - время действия. <br><br>Рекомендации астрологов:<br>• Преодоление препятствий<br>• Принятие важных решений<br>• Деловые переговоры<br>• Активные действия",
                
                "Растущая луна": "<strong>Растущая луна</strong> - время накопления. <br><br>Рекомендации астрологов:<br>• Наращивание ресурсов<br>• Инвестиции<br>• Осуществление важных покупок<br>• Усиленное питание",
                
                "Полнолуние": "<strong>Полнолуние</strong> - время завершения и высшей энергии. <br><br>Рекомендации астрологов:<br>• Завершение важных дел<br>• Публичные выступления<br>• Творческая деятельность<br>• Медитации на исполнение желаний",
                
                "Убывающая луна": "<strong>Убывающая луна</strong> - время анализа. <br><br>Рекомендации астрологов:<br>• Подведение итогов<br>• Самоанализ<br>• Избавление от ненужного<br>• Разрешение конфликтов",
                
                "Последняя четверть": "<strong>Последняя четверть</strong> - время переосмысления. <br><br>Рекомендации астрологов:<br>• Завершение дел<br>• Уборка и очищение пространства<br>• Прощение и отпускание<br>• Подготовка к новому циклу",
                
                "Убывающий полумесяц": "<strong>Убывающий полумесяц</strong> - время отдыха. <br><br>Рекомендации астрологов:<br>• Минимизация активности<br>• Отдых и релаксация<br>• Внутренняя работа<br>• Планирование будущего"
            };
            
            return descriptions[phaseName] || "Нет специфических рекомендаций для этой фазы луны.";
        }

        // Функция для определения номера лунного цикла
        function getLunarCycleNumber(date) {
            // Используем не фиксированную дату, а первое новолуние для выбранного года
            if (!firstNewMoonReference) {
                updateFirstNewMoonReference();
            }
            
            // Длительность лунного цикла в миллисекундах
            const lunarCycleInMs = 29.53058867 * 24 * 60 * 60 * 1000;
            
            // Вычисляем, сколько лунных циклов прошло
            const timeDiff = date.getTime() - firstNewMoonReference.getTime();
            const cyclesPassed = timeDiff / lunarCycleInMs;
            
            // Если дата до первого новолуния выбранного года
            if (timeDiff < 0) {
                // Получаем год из выбранной стартовой даты
                const selectedYear = startDate.getFullYear();
                return `13 (${selectedYear - 1})`;
            }
            
            // Иначе определяем номер цикла в выбранном году
            return Math.floor(cyclesPassed) + 1;
        }

        // Функция для обновления референсной даты первого новолуния
        function updateFirstNewMoonReference() {
            const selectedYear = startDate.getFullYear();
            
            // Таблица первых новолуний по годам (можно расширить при необходимости)
            const firstNewMoons = {
                2023: new Date(2023, 0, 21), // 21 января 2023
                2024: new Date(2024, 0, 11), // 11 января 2024
                2025: new Date(2025, 0, 29), // 29 января 2025
                2026: new Date(2026, 0, 18), // 18 января 2026
                2027: new Date(2027, 0, 7),  // 7 января 2027
                2028: new Date(2028, 0, 27), // 27 января 2028
                2029: new Date(2029, 0, 15), // 15 января 2029
                2030: new Date(2030, 0, 5)   // 5 января 2030
            };
            
            // Если у нас есть данные о первом новолунии для выбранного года
            if (firstNewMoons[selectedYear]) {
                firstNewMoonReference = firstNewMoons[selectedYear];
            } else {
                // Если нет данных, используем примерный расчет
                // Лунный цикл ≈ 29.53 дней, 12 циклов ≈ 354.36 дней (год)
                // Находим ближайший известный год и экстраполируем
                let closestYear = 2025; // Берем за основу
                let closestNewMoon = new Date(firstNewMoons[closestYear]);
                
                // Количество лет разницы
                const yearDiff = selectedYear - closestYear;
                
                // Примерное смещение новолуния (сдвиг на 11 дней каждый год)
                // Синодический месяц ≈ 29.53 дней, солнечный год ≈ 365.25 дней
                // Разница ≈ 10.88 дней в год
                closestNewMoon.setDate(closestNewMoon.getDate() + yearDiff * 11);
                
                // Корректируем на високосные годы
                const leapYearsCount = Math.floor(yearDiff / 4);
                closestNewMoon.setDate(closestNewMoon.getDate() + leapYearsCount);
                
                firstNewMoonReference = closestNewMoon;
            }
        }

        // Функция для получения расширенных астрологических рекомендаций
        function getExtendedRecommendations(weekNumber, moonPhase, date) {
            // Определяем планетарные влияния на основе номера недели и даты
            const planetsInfluence = getPlanetaryInfluence(weekNumber, date);
            
            // Формируем базовую часть рекомендаций на основе фазы луны
            let baseRecommendation = "<strong>Расширенные астрологические рекомендации</strong><br><br>";
            
            // Добавляем фазу луны
            baseRecommendation += `В течение этой недели преобладает <strong>${moonPhase}</strong>.<br>`;
            
            // Формируем рекомендации на основе фазы луны
            baseRecommendation += getLunarPhaseAdvice(moonPhase);
            
            // Добавляем рекомендации по планетарным влияниям
            baseRecommendation += "<div class='planet-influence'><strong>Планетарные влияния этой недели:</strong><br>";
            
            // Добавляем влияния каждой планеты
            planetsInfluence.forEach(planet => {
                baseRecommendation += `<br><strong>${planet.name}:</strong> ${planet.influence}<br>`;
            });
            
            baseRecommendation += "</div>";
            
            return baseRecommendation;
        }
        
        // Функция для определения планетарных влияний
        function getPlanetaryInfluence(weekNumber, date) {
            // Определяем планетарные влияния на основе номера недели
            // Это упрощенная имитация, в реальности нужны сложные астрономические расчеты
            
            const planets = [
                { name: "Меркурий", influences: [
                    "способствует интеллектуальной деятельности и коммуникации",
                    "благоприятствует обучению и новым знакомствам",
                    "может вызывать недопонимание и задержки в передаче информации",
                    "усиливает аналитические способности и внимание к деталям"
                ]},
                { name: "Венера", influences: [
                    "усиливает чувственность и гармонию в отношениях",
                    "благоприятствует творчеству и эстетическому восприятию",
                    "способствует финансовому благополучию и приобретениям",
                    "помогает находить компромиссы и мирные решения"
                ]},
                { name: "Марс", influences: [
                    "придает энергию и решительность в действиях",
                    "может вызывать конфликты и напряженность",
                    "способствует спортивным достижениям и физической активности",
                    "усиливает лидерские качества и инициативность"
                ]},
                { name: "Юпитер", influences: [
                    "расширяет возможности и открывает новые перспективы",
                    "способствует успеху в образовании и путешествиях",
                    "приносит оптимизм и веру в будущее",
                    "благоприятствует финансовому росту и щедрости"
                ]},
                { name: "Сатурн", influences: [
                    "требует дисциплины и ответственного подхода",
                    "может замедлять процессы, но делает результаты стабильными",
                    "способствует долгосрочному планированию",
                    "проверяет на прочность существующие структуры"
                ]},
                { name: "Уран", influences: [
                    "приносит неожиданные изменения и возможности",
                    "способствует инновациям и нестандартным решениям",
                    "может вызывать нестабильность и внезапные перемены",
                    "помогает освободиться от устаревших шаблонов"
                ]},
                { name: "Нептун", influences: [
                    "усиливает интуицию и духовные прозрения",
                    "может вызывать иллюзии и неясность в восприятии",
                    "способствует творческому вдохновению и состраданию",
                    "размывает границы и условности"
                ]},
                { name: "Плутон", influences: [
                    "требует глубинной трансформации и обновления",
                    "может вызывать кризисные ситуации для последующего роста",
                    "усиливает волю и внутреннюю силу",
                    "помогает обнаружить скрытые ресурсы и возможности"
                ]}
            ];
            
            // Выбираем 3-4 планеты, которые имеют наибольшее влияние в эту неделю
            // Используем хеш-функцию от номера недели и месяца, чтобы выбор был псевдослучайным,
            // но стабильным для одной и той же недели
            const month = date.getMonth();
            const hash = (weekNumber * 13 + month * 7) % 100;
            
            // Определяем количество активных планет (3 или 4)
            const planetCount = hash % 2 === 0 ? 3 : 4;
            
            // Выбираем планеты
            const selectedPlanets = [];
            let remainingPlanets = [...planets];
            
            for (let i = 0; i < planetCount; i++) {
                const index = (hash + i * 17) % remainingPlanets.length;
                const planet = remainingPlanets[index];
                
                // Выбираем влияние для планеты
                const influenceIndex = (hash + weekNumber + i) % planet.influences.length;
                
                selectedPlanets.push({
                    name: planet.name,
                    influence: planet.influences[influenceIndex]
                });
                
                // Удаляем выбранную планету из списка
                remainingPlanets.splice(index, 1);
            }
            
            return selectedPlanets;
        }
        
        // Функция для получения рекомендаций на основе лунной фазы
        function getLunarPhaseAdvice(moonPhase) {
            const phaseAdvice = {
                "Новолуние": "Это идеальное время для начала новых проектов, особенно тех, которые требуют креативного подхода. Уделите время медитации и внутреннему самоанализу. Запишите свои цели и намерения на предстоящий лунный цикл. Рекомендуется снизить физическую активность и больше отдыхать.",
                
                "Растущий полумесяц": "Энергия начинает нарастать, используйте её для активного развития начатых проектов. Эффективны занятия, направленные на обучение и развитие новых навыков. Благоприятное время для социальных контактов и укрепления отношений. Физическая активность приносит особую пользу.",
                
                "Первая четверть": "Наступает время преодоления первых препятствий в начатых проектах. Проявите настойчивость и не отклоняйтесь от намеченного пути. Благоприятный период для принятия важных решений и проведения переговоров. Рекомендуется сосредоточиться на достижении краткосрочных целей.",
                
                "Растущая луна": "Продолжайте развивать начатые проекты, внося необходимые корректировки. Хорошее время для инвестиций и крупных приобретений. Обратите внимание на правильное питание — организм в этот период особенно хорошо усваивает питательные вещества. Эффективны практики на привлечение благополучия.",
                
                "Полнолуние": "Время максимальной энергии и реализации. Завершайте важные дела и проекты. Благоприятный период для публичных выступлений и презентаций. Будьте внимательны к своим эмоциям — они могут быть особенно интенсивными. Практикуйте благодарность и отпускание ненужного.",
                
                "Убывающая луна": "Наступает время для подведения итогов и анализа результатов. Сократите активность и сосредоточьтесь на завершении начатого. Благоприятный период для избавления от ненужных вещей, привычек и связей. Практикуйте прощение себя и других, отпускайте обиды и негативные эмоции.",
                
                "Последняя четверть": "Время для осмысления уроков завершающегося цикла. Завершите все начатые дела. Благоприятный период для уборки, очищения пространства и избавления от всего лишнего. Уделите внимание размышлениям о будущем и внутренней работе. Практикуйте прощение и отпускание.",
                
                "Убывающий полумесяц": "Период наименьшей энергии перед новым циклом. Максимально сократите активность и предоставьте себе больше отдыха. Занимайтесь легкими, спокойными делами. Идеальное время для медитации, сна и восстановления сил. Подготовьтесь к новому циклу, но не начинайте ничего важного."
            };
            
            return phaseAdvice[moonPhase] || "Нет специфических рекомендаций для этой фазы луны.";
        }

        // Функция для определения, нужно ли подсвечивать неделю с "Последней четвертью"
        function shouldHighlightLastQuarter(predominantPhase, weekPhases, prevWeekPhases, nextWeekPhases) {
            // Если преобладающая фаза недели - "Последняя четверть", подсвечиваем
            if (predominantPhase.name === "Последняя четверть") {
                return true;
            }
            
            // Подсчитываем количество дней с фазой "Последняя четверть" на текущей неделе
            const currentLastQuarterCount = weekPhases.filter(phase => phase.name === "Последняя четверть").length;
            
            // Если "Последней четверти" нет на этой неделе, не подсвечиваем
            if (currentLastQuarterCount === 0) {
                return false;
            }
            
            // Подсчитываем на соседних неделях
            const prevLastQuarterCount = prevWeekPhases.filter(phase => phase.name === "Последняя четверть").length;
            const nextLastQuarterCount = nextWeekPhases.filter(phase => phase.name === "Последняя четверть").length;
            
            // Подсвечиваем, если на текущей неделе больше дней с фазой "Последняя четверть", 
            // чем на предыдущей И следующей неделях
            return (currentLastQuarterCount > prevLastQuarterCount && 
                    currentLastQuarterCount > nextLastQuarterCount);
        }

        // Инициализация кастомного date picker
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('datepicker-input');
            const hiddenInput = document.getElementById('start-date');
            const calendar = document.getElementById('datepicker-calendar');
            const prevBtn = document.querySelector('.prev-month');
            const nextBtn = document.querySelector('.next-month');
            const monthDisplay = document.querySelector('.month-display');
            const daysContainer = document.querySelector('.calendar-days');
            const closeBtn = document.querySelector('.close-btn');
            
            let currentDate = new Date(2025, 0, 1);
            let selectedDate = new Date(2025, 0, 1);
            
            // Открытие/закрытие календаря при клике на поле ввода
            dateInput.addEventListener('click', function() {
                calendar.style.display = 'block';
                renderCalendar(currentDate);
            });
            
            // Закрытие календаря при клике вне его
            document.addEventListener('click', function(e) {
                if (!calendar.contains(e.target) && e.target !== dateInput) {
                    calendar.style.display = 'none';
                }
            });
            
            // Закрытие календаря по кнопке
            closeBtn.addEventListener('click', function() {
                calendar.style.display = 'none';
            });
            
            // Обработка кнопок навигации по месяцам
            prevBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate);
            });
            
            nextBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate);
            });
            
            // Функция отрисовки календаря
            function renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // Обновляем заголовок с месяцем и годом
                const monthNames = [
                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                ];
                monthDisplay.textContent = `${monthNames[month]} ${year}`;
                
                // Очищаем контейнер дней
                daysContainer.innerHTML = '';
                
                // Получаем первый день месяца
                const firstDay = new Date(year, month, 1);
                
                // Определяем день недели первого дня месяца (0 - воскресенье, 1 - понедельник и т.д.)
                // Корректируем для начала недели с понедельника (0 - понедельник, 6 - воскресенье)
                let firstDayOfWeek = firstDay.getDay() || 7;
                firstDayOfWeek = firstDayOfWeek === 1 ? 0 : firstDayOfWeek - 1;
                
                // Получаем последний день месяца
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                
                // Получаем последний день предыдущего месяца
                const prevMonthLastDay = new Date(year, month, 0).getDate();
                
                // Заполняем дни предыдущего месяца
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const day = prevMonthLastDay - firstDayOfWeek + i + 1;
                    const dayElement = createDayElement(day, 'other-month');
                    
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    
                    dayElement.addEventListener('click', function() {
                        selectDate(new Date(prevYear, prevMonth, day));
                    });
                    
                    daysContainer.appendChild(dayElement);
                }
                
                // Заполняем дни текущего месяца
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayElement = createDayElement(i);
                    
                    // Отмечаем текущий день и выбранный день
                    const dayDate = new Date(year, month, i);
                    const today = new Date();
                    
                    if (isSameDay(dayDate, today)) {
                        dayElement.classList.add('today');
                    }
                    
                    if (isSameDay(dayDate, selectedDate)) {
                        dayElement.classList.add('selected');
                    }
                    
                    dayElement.addEventListener('click', function() {
                        selectDate(new Date(year, month, i));
                    });
                    
                    daysContainer.appendChild(dayElement);
                }
                
                // Заполняем дни следующего месяца
                const totalDaysShown = firstDayOfWeek + daysInMonth;
                const nextMonthDays = 42 - totalDaysShown; // 6 строк по 7 дней = 42
                
                for (let i = 1; i <= nextMonthDays; i++) {
                    const dayElement = createDayElement(i, 'other-month');
                    
                    const nextMonth = month === 11 ? 0 : month + 1;
                    const nextYear = month === 11 ? year + 1 : year;
                    
                    dayElement.addEventListener('click', function() {
                        selectDate(new Date(nextYear, nextMonth, i));
                    });
                    
                    daysContainer.appendChild(dayElement);
                }
            }
            
            // Функция создания элемента дня
            function createDayElement(day, className = '') {
                const dayElement = document.createElement('div');
                dayElement.textContent = day;
                dayElement.className = 'calendar-day';
                
                if (className) {
                    dayElement.classList.add(className);
                }
                
                return dayElement;
            }
            
            // Функция выбора даты
            function selectDate(date) {
                selectedDate = date;
                
                // Обновляем значение в поле ввода
                dateInput.value = formatDate(date);
                
                // Обновляем скрытое поле
                hiddenInput.value = formatDateISO(date);
                
                // Закрываем календарь
                calendar.style.display = 'none';
                
                // Перерисовываем календарь
                renderCalendar(date);
            }
            
            // Функция форматирования даты (ДД.ММ.ГГГГ)
            function formatDate(date) {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}.${month}.${year}`;
            }
            
            // Функция форматирования даты в ISO формат (ГГГГ-ММ-ДД)
            function formatDateISO(date) {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                
                return `${year}-${month}-${day}`;
            }
            
            // Функция проверки, совпадают ли даты
            function isSameDay(date1, date2) {
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            }
            
            // Инициализация календаря
            renderCalendar(currentDate);
        });
    </script>
</body>
</html>
